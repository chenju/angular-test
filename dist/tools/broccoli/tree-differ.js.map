{"version":3,"sources":["broccoli/tree-differ.ts"],"names":["TreeDiffer","TreeDiffer.constructor","TreeDiffer.constructor.combine","TreeDiffer.diffTree","TreeDiffer.dirtyCheckPath","TreeDiffer.isFileDirty","TreeDiffer.detectDeletionsAndUpdateFingerprints","DirtyCheckingDiffResult","DirtyCheckingDiffResult.constructor","DirtyCheckingDiffResult.toString","DirtyCheckingDiffResult.log","pad"],"mappings":"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","file":"broccoli/tree-differ.js","sourcesContent":["/// <reference path=\"../typings/node/node.d.ts\" />\r\n\r\nimport fs = require('fs');\r\nimport path = require('path');\r\n\r\n\r\nexport class TreeDiffer {\r\n  private fingerprints: {[key: string]: string} = Object.create(null);\r\n  private nextFingerprints: {[key: string]: string} = Object.create(null);\r\n  private rootDirName: string;\r\n  private include: RegExp = null;\r\n  private exclude: RegExp = null;\r\n\r\n  constructor(private rootPath: string, includeExtensions?: string[],\r\n              excludeExtensions?: string[]) {\r\n    this.rootDirName = path.basename(rootPath);\r\n\r\n    let buildRegexp = (arr) => new RegExp(`(${arr.reduce(combine, \"\")})$`, \"i\");\r\n\r\n    this.include = (includeExtensions || []).length ? buildRegexp(includeExtensions) : null;\r\n    this.exclude = (excludeExtensions || []).length ? buildRegexp(excludeExtensions) : null;\r\n\r\n    function combine(prev, curr) {\r\n      if (curr.charAt(0) !== \".\") throw new TypeError(\"Extension must begin with '.'\");\r\n      let kSpecialRegexpChars = /[\\-\\[\\]\\/\\{\\}\\(\\)\\*\\+\\?\\.\\\\\\^\\$\\|]/g;\r\n      curr = '(' + curr.replace(kSpecialRegexpChars, '\\\\$&') + ')';\r\n      return prev ? (prev + '|' + curr) : curr;\r\n    }\r\n  }\r\n\r\n\r\n  public diffTree(): DiffResult {\r\n    let result = new DirtyCheckingDiffResult(this.rootDirName);\r\n    this.dirtyCheckPath(this.rootPath, result);\r\n    this.detectDeletionsAndUpdateFingerprints(result);\r\n    result.endTime = Date.now();\r\n    return result;\r\n  }\r\n\r\n\r\n  private dirtyCheckPath(rootDir: string, result: DirtyCheckingDiffResult) {\r\n    fs.readdirSync(rootDir).forEach((segment) => {\r\n      let absolutePath = path.join(rootDir, segment);\r\n      let pathStat = fs.statSync(absolutePath);\r\n\r\n      if (pathStat.isDirectory()) {\r\n        result.directoriesChecked++;\r\n        this.dirtyCheckPath(absolutePath, result);\r\n      } else {\r\n        if (!(this.include && !absolutePath.match(this.include)) &&\r\n            !(this.exclude && absolutePath.match(this.exclude))) {\r\n          result.filesChecked++;\r\n          if (this.isFileDirty(absolutePath, pathStat)) {\r\n            result.changedPaths.push(path.relative(this.rootPath, absolutePath));\r\n          }\r\n        }\r\n      }\r\n    });\r\n\r\n    return result;\r\n  }\r\n\r\n\r\n  private isFileDirty(path: string, stat: fs.Stats): boolean {\r\n    let oldFingerprint = this.fingerprints[path];\r\n    let newFingerprint = `${stat.mtime.getTime()} # ${stat.size}`;\r\n\r\n    this.nextFingerprints[path] = newFingerprint;\r\n\r\n    if (oldFingerprint) {\r\n      this.fingerprints[path] = null;\r\n\r\n      if (oldFingerprint === newFingerprint) {\r\n        // nothing changed\r\n        return false;\r\n      }\r\n    }\r\n\r\n    return true;\r\n  }\r\n\r\n\r\n  private detectDeletionsAndUpdateFingerprints(result: DiffResult) {\r\n    for (let absolutePath in this.fingerprints) {\r\n      if (!(this.include && !absolutePath.match(this.include)) &&\r\n          !(this.exclude && absolutePath.match(this.exclude))) {\r\n        if (this.fingerprints[absolutePath] !== null) {\r\n          let relativePath = path.relative(this.rootPath, absolutePath);\r\n          result.removedPaths.push(relativePath);\r\n        }\r\n      }\r\n    }\r\n\r\n    this.fingerprints = this.nextFingerprints;\r\n    this.nextFingerprints = Object.create(null);\r\n  }\r\n}\r\n\r\n\r\nexport interface DiffResult {\r\n  changedPaths: string[];\r\n  removedPaths: string[];\r\n  log(verbose: boolean): void;\r\n  toString(): string;\r\n}\r\n\r\n\r\nclass DirtyCheckingDiffResult {\r\n  public filesChecked: number = 0;\r\n  public directoriesChecked: number = 0;\r\n  public changedPaths: string[] = [];\r\n  public removedPaths: string[] = [];\r\n  public startTime: number = Date.now();\r\n  public endTime: number = null;\r\n\r\n  constructor(public name: string) {}\r\n\r\n  toString() {\r\n    return `${pad(this.name, 40)}, duration: ${pad(this.endTime - this.startTime, 5)}ms, ` +\r\n           `${pad(this.changedPaths.length + this.removedPaths.length, 5)} changes detected ` +\r\n           `(files: ${pad(this.filesChecked, 5)}, directories: ${pad(this.directoriesChecked, 4)})`;\r\n  }\r\n\r\n  log(verbose) {\r\n    let prefixedPaths =\r\n        this.changedPaths.map((p) => `* ${p}`).concat(this.removedPaths.map((p) => `- ${p}`));\r\n    console.log(`Tree diff: ${this}` + ((verbose && prefixedPaths.length) ?\r\n                                             ` [\\n  ${prefixedPaths.join('\\n  ')}\\n]` :\r\n                                             ''));\r\n  }\r\n}\r\n\r\n\r\nfunction pad(value, length) {\r\n  value = '' + value;\r\n  let whitespaceLength = (value.length < length) ? length - value.length : 0;\r\n  whitespaceLength = whitespaceLength + 1;\r\n  return new Array(whitespaceLength).join(' ') + value;\r\n}\r\n"],"sourceRoot":"/source/"}